<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bus Route - Live</title>
    <meta name="color-scheme" content="dark light" />
    <style>
        :root {
            --bg: #0b0f17;
            --bg-2: #111827;
            --panel: #0f172a;
            --panel-2: #111c31;
            --rail: #22c3a9;
            --rail2: #5aa0ff;
            --accent: #f59e0b;
            --text: #e5e7eb;
            --muted: #a1a1aa;
            --border: #1f2937;
            --node: #e2e8f0;
            --good: #34d399;
        }

        html[data-theme="light"] {
            --bg: #f9fafb;
            --bg-2: #ffffff;
            --panel: #ffffff;
            --panel-2: #f3f4f6;
            --rail: #2563eb;
            --rail2: #22c3a9;
            --accent: #d97706;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #d1d5db;
            --node: #374151;
            --good: #059669;
        }

        * {
            box-sizing: border-box;
        }

        html:focus-within {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            html:focus-within {
                scroll-behavior: auto;
            }
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 50%, #0c1322 100%);
            color: var(--text);
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #0f172acc;
            backdrop-filter: saturate(140%) blur(6px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .brand {
            display: flex;
            align-items: center;
            font-size: 150%;
            gap: 0.8rem;
            font-weight: 800;
            font-family: 'Trebuchet MS';
        }

        .pill {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: conic-gradient(from 180deg, var(--rail), #7dd3fc, var(--rail));
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .field {
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 220px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 10px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
        }

        select {
            flex: 1;
            background: #0b1220;
            color: var(--text);
            border: none;
            outline: none;
            font: inherit;
            border-radius: 10px;
        }

        select:focus-visible {
            outline: 2px solid var(--rail);
            outline-offset: 2px;
            border-radius: 8px;
        }

        select::-webkit-listbox {
            background: #0b1220;
            color: var(--text);
            border: 1px solid var(--border);
        }

        select::-webkit-selection,
        select option:checked {
            background: #182338;
            color: #ffffff;
        }

        select option {
            background: #0b1220;
            color: var(--text);
        }

        select option:hover,
        select option:checked {
            background: #182338;
            color: #ffffff;
        }

        html[data-theme="light"] select {
            background: #fff;
            color: var(--text);
        }

        html[data-theme="light"] select::-webkit-listbox,
        html[data-theme="light"] select option {
            background: #fff;
            color: var(--text);
            border-color: var(--border);
        }

        html[data-theme="light"] select option:hover,
        html[data-theme="light"] select option:checked,
        html[data-theme="light"] select::-webkit-selection {
            background: #f3f4f6;
            color: var(--text);
        }

        .lang {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px 10px;
        }

        .lang select {
            min-width: 140px;
        }

        main {
            max-width: 1180px;
            margin: 16px auto;
            padding: 0 16px;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 18px;
        }

        @media (max-width: 980px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
        }

        .panel h2,
        .panel h3 {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .8px;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            min-height: 80px;
            padding-left: 28px;
        }

        .axis {
            position: absolute;
            left: 14px;
            width: 4px;
            border-radius: 4px;
            background: linear-gradient(180deg, var(--rail), #7dd3fc);
            z-index: 1;
            top: 0;
            bottom: 0;
        }

        .stop {
            position: relative;
            margin: 18px 0;
            padding: 14px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            border-radius: 14px;
            transition: transform .15s ease, background .2s;
            z-index: 2;
            width: calc(100% - 14px);
        }

        .stop:hover {
            background: rgba(255, 255, 255, .06);
            transform: translateY(-1px);
        }

        html[data-theme="light"] .stop {
            background: #fff;
            border-color: var(--border);
        }

        html[data-theme="light"] .stop:hover {
            background: #f3f4f6;
        }

        .dot {
            position: absolute;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--node);
            border: 3px solid var(--rail);
            box-shadow: 0 0 0 3px rgba(34, 195, 169, .25);
            z-index: 2;
        }

        .bus-icon {
            position: absolute;
            left: 10px;
            width: 12px;
            height: 12px;
            background-color: var(--accent);
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 8px var(--accent);
            top: 0;
            transform: translateY(0);
        }

        @keyframes moveBus {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(300px);
            }
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .name {
            font-weight: 800;
        }

        .meta {
            font-size: 12px;
            color: var(--muted);
        }

        .eta {
            color: var(--accent);
            font-weight: 800;
        }

        .in-range {
            background: rgba(34, 195, 169, .10);
            border-color: #0ee9be;
        }

        html[data-theme="light"] .in-range {
            background: #e0f2fe;
            border-color: #bae6fd;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(34, 195, 169, .12);
            border: 1px solid rgba(34, 195, 169, .55);
            color: var(--rail);
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: .3px;
        }

        .spin {
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            grid-template-rows: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .stat {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        html[data-theme="light"] .stat {
            background: #fafafa;
            border-color: var(--border);
        }

        .label {
            font-size: 12px;
            color: var(--muted);
        }

        .value {
            font-weight: 900;
            font-size: 20px;
            margin-top: 2px;
        }

        .fab {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 18;
            background: linear-gradient(135deg, var(--rail), #86e3d3);
            color: #0a1b1a;
            border: none;
            border-radius: 999px;
            padding: 14px 18px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, .35);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fab small {
            display: block;
            font-size: 10px;
            opacity: .85;
            letter-spacing: .3px;
        }

        .fab .big {
            font-size: 22px;
            font-weight: 900;
        }

        .em-trigger {
            position: fixed;
            right: 16px;
            bottom: 96px;
            z-index: 18;
            background: #f00606;
            border: 1px solid var(--border);
            color: #efefef;
            font-weight: 800;
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .3);
            font-size: 80%;
        }

        .em-menu {
            position: fixed;
            right: 16px;
            bottom: 146px;
            z-index: 18;
            display: none;
            min-width: 230px;
            background: #101828;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .3);
        }

        .em-menu.open {
            display: block;
        }

        .em-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #1f2a3e;
        }

        .em-item:last-child {
            border-bottom: none;
        }

        .em-item small {
            color: var(--muted);
        }

        .em-item a {
            background: radial-gradient(circle at 30% 30%, #ffd1d1, #ff6b6b);
            color: #2b0b0b;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 800;
        }

        .chat-fab {
            position: fixed;
            left: 16px;
            bottom: 16px;
            z-index: 18;
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: none;
            background: conic-gradient(from 180deg at 50% 50%, #86efac, #22c3a9, #5aa0ff, #86efac);
            color: #0a1632;
            display: grid;
            place-items: center;
            box-shadow: 0 12px 36px rgba(0, 0, 0, .35);
            cursor: pointer;
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
        }

        .chat {
            position: fixed;
            left: 16px;
            bottom: 86px;
            z-index: 18;
            width: 320px;
            max-height: 60vh;
            display: none;
            flex-direction: column;
            background: #101828;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }

        .chat.open {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
            padding: 10px 12px;
            background: #0f172a;
            border-bottom: 1px solid var(--border);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
        }

        .chat-logo {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff, #9be7ff);
        }

        .chat-body {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
        }

        .bubble {
            max-width: 80%;
            padding: 8px 10px;
            border-radius: 12px;
        }

        .bot {
            background: #14223d;
            color: #e2ebff;
            align-self: flex-start;
        }

        .me {
            background: #1b2a4d;
            color: #e2ebff;
            align-self: flex-end;
        }

        .chat-input {
            display: flex;
            gap: 6px;
            padding: 10px;
            border-top: 1px solid var(--border);
            background: #101828;
        }

        .chat-input input {
            flex: 1;
            background: #0b1220;
            border: 1px solid #1f2a3e;
            border-radius: 10px;
            color: var(--text);
            padding: 8px;
        }

        .chat-input button {
            background: linear-gradient(135deg, var(--rail), #7de6d5);
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            color: #0a1b1a;
            font-weight: 800;
        }

        #themeToggle {
            background: var(--panel-2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: 600;
        }

        /*Map releated*/
        #map {
            height: 400px;
            width: 100%;
        }
    </style> <!--Map releated-->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Laptop Location Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <header>
        <div class="brand"><span class="pill" aria-hidden="true"></span> <span id="title">Bus Route Live</span></div>
        <div class="toolbar" role="group" aria-label="Selections">
            <div class="field"><label for="busSel" id="lblBus">Bus</label><select id="busSel" name="bus"></select></div>
            <div class="field"><label for="startSel" id="lblStart">Start</label><select id="startSel"
                    name="start"></select></div>
            <div class="field"><label for="endSel" id="lblEnd">End</label><select id="endSel" name="end"></select></div>
            <div class="lang" aria-label="Language picker"> <label for="langSel" id="lblLang">Language</label> <select
                    id="langSel">
                    <option value="en" lang="en" selected>English</option>
                    <option value="hi" lang="hi">हिंदी</option>
                    <option value="pa" lang="pa">ਪੰਜਾਬੀ</option>
                </select> </div> <button id="themeToggle">🌙</button> <span class="chip" id="liveBadge"><span
                    class="spin" aria-hidden="true"></span> LIVE</span>
        </div>
    </header>
    <main>
        <section class="panel" aria-labelledby="routeTitle">
            <h2 id="routeTitle">Route timeline</h2>
            <div class="timeline" id="timeline" role="list">
                <div class="axis" aria-hidden="true"></div>
                <div id="bus-icon" class="bus-icon"></div>
            </div>
        </section>
        <aside class="panel" aria-labelledby="detailsTitle">
            <h2 id="detailsTitle">Details</h2>
            <div class="grid">
                <div class="stat">
                    <div class="label" id="lblSpeed">Current speed</div>
                    <div class="value"><span id="speedVal">--</span> km/h</div>
                </div>
                <div class="stat">
                    <div class="label" id="lblEta">ETA to end</div>
                    <div class="value" id="etaVal">--</div>
                </div>
                <div class="stat">
                    <div class="label" id="distLabel">Distance (km)</div>
                    <div class="value" id="distanceVal">--</div>
                </div>
                <div class="stat">
                    <div class="label" id="coveredLabel">Route Covered (%)</div>
                    <div class="value" id="percentVal">--</div>
                </div>
                <div class="stat">
                    <div class="label" id="stopsLabel">Stops</div>
                    <div class="value" id="stopCountVal">--</div>
                </div>
            </div> <button id="showMapBtn">Show Live Map</button> <button id="hideMapBtn"
                style="display:none; margin-left: 10px;">Hide Map</button>
            <div id="mapContainer"
                style="width: 700px; height: 450px; border: 2px solid #888; border-radius: 8px; box-shadow: 2px 2px 8px rgba(0,0,0,0.2); overflow: hidden; display: none;">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
            <p class="label" style="margin-top:10px" id="geoHint">Pick a bus, then choose Start and End stops; allow
                location for live speed.</p>
        </aside>
    </main> <button class="em-trigger" id="emBtn" aria-haspopup="true" aria-expanded="false">⚠ Emergency</button>
    <div class="em-menu" id="emMenu" role="menu" aria-label="Emergency contacts">
        <div class="em-item" role="menuitem">
            <div><strong id="polLbl">Police</strong> <small>100</small></div><a href="tel:100" id="polAct">Call</a>
        </div>
        <div class="em-item" role="menuitem">
            <div><strong id="hosLbl">Hospital</strong> <small>108</small></div><a href="tel:108" id="hosAct">Call</a>
        </div>
        <div class="em-item" role="menuitem">
            <div><strong id="busLbl">Bus Service</strong> <small>1800-000-111</small></div><a href="tel:1800000111"
                id="busAct">Call</a>
        </div>
    </div> <button class="fab" id="speedFab" aria-live="polite">
        <div><small id="speedSmall">Speed</small>
            <div class="big" id="speedFabVal">-- km/h</div>
        </div>
    </button> <button class="chat-fab" id="chatToggle" aria-label="Open chatbot"><svg viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M21 15a4 4 0 0 1-4 4H9l-6 4 2-6a8 8 0 1 1 16-2Z" />
            <circle cx="9" cy="13" r="1" />
            <circle cx="13" cy="13" r="1" />
            <circle cx="17" cy="13" r="1" />
        </svg></button>
    <section class="chat" id="chatBox" aria-label="Chatbot" aria-live="polite">
        <div class="chat-header">
            <div class="chat-title"><span class="chat-logo" aria-hidden="true"></span><span
                    id="chatTitle">Chatbot</span></div><button
                style="background:#1b263b;border:none;color:#dbe7ff;border-radius:8px;padding:4px 8px"
                id="chatClose">×</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="bubble bot" id="chatWelcome">Hi! Ask about routes, stops, or ETAs.</div>
        </div>
        <form class="chat-input" id="chatForm"><input type="text" id="chatMsg" placeholder="Type message..."
                autocomplete="off" /><button type="submit" id="sendBtn">Send</button></form>
    </section>
    
    <script>
        // --- UTILITY AND CONSTANTS ---
        const id = (id) => document.getElementById(id);

        // Correctly defined constants
        const busSel = id('busSel'),
            startSel = id('startSel'),
            endSel = id('endSel'),
            speedVal = id('speedVal'),
            speedFabVal = id('speedFabVal'),
            etaVal = id('etaVal'),
            themeToggle = id('themeToggle');

        // Hidden holders for per-station ETA values (required by instructions). We create them if not present.
        // timeVal = station1, timeVal1 = station2, timeVal2 = station3, timeVal3 = station4
        // distanceVal1..3 are optional extras paired with time indices.
        function ensureHiddenHolders() {
            const ensure = (elemId) => {
                if (!document.getElementById(elemId)) {
                    const span = document.createElement('span');
                    span.id = elemId;
                    span.style.display = 'none';
                    document.body.appendChild(span);
                }
            };
            ensure('timeVal');
            ensure('timeVal1');
            ensure('timeVal2');
            ensure('timeVal3');

            ensure('distanceVal1');
            ensure('distanceVal2');
            ensure('distanceVal3');
        }
        ensureHiddenHolders();

        // Data for buses and stops
        const BUSES = [
            { id: 'B1', name: 'Bus 1' },
            { id: 'B2', name: 'Bus 2' },
            { id: 'B3', name: 'Bus 3' },
        ];
        const STOPS = {
            'B1': [
                { id: 'S1', name: 'Station 1', km: 0 },
                { id: 'S2', name: 'Station 2', km: 4 },
                { id: 'S3', name: 'Station 3', km: 8 },
                { id: 'S4', name: 'Station 4', km: 12 },
            ],
            'B2': [
                { id: 'S5', name: 'Station 5', km: 0 },
                { id: 'S6', name: 'Station 6', km: 7 },
                { id: 'S7', name: 'Station 7', km: 22 },
            ],
            'B3': [
                { id: 'S8', name: 'Station 8', km: 0 },
                { id: 'S9', name: 'Station 9', km: 3 },
                { id: 'S10', name: 'Station 10', km: 5 },
            ],
        };
        let currentStops = [];

        // --- TIMELINE RENDERING ---
        function renderStops(stops) {
            const timeline = id('timeline');
            if (!timeline) {
                console.error("Timeline element not found!");
                return;
            }
            // Clear previous stops before rendering new ones
            timeline.innerHTML = '<div class="axis" aria-hidden="true"></div><div id="bus-icon" class="bus-icon"></div>';
            currentStops = stops;

            // Adjust axis full height
            const axis = timeline.querySelector('.axis');
            if (axis) {
                axis.style.top = '0px';
                axis.style.bottom = '0px';
            }

            stops.forEach(s => {
                const el = document.createElement('div');
                el.className = 'stop';
                el.dataset.id = s.id;
                el.setAttribute('role', 'listitem');
                el.innerHTML = `
                <span class="dot" aria-hidden="true"></span>
                <div class="row">
                    <div>
                        <div class="name">${s.name}</div>
                        <div class="meta">${s.km} km from start</div>
                    </div>
                    <div class="eta" id="eta-${s.id}">ETA --</div>
                </div>`;
                timeline.appendChild(el);
            });

            // Update stop count display
            const stopCountVal = id('stopCountVal');
            if (stopCountVal) stopCountVal.textContent = String(stops.length);

            // After render, reposition bus icon to top by default
            positionBusIconByProgress(0);
        }

        function loadStops(busId) {
            const stops = STOPS[busId] || [];
            const opts = stops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            startSel.innerHTML = opts;
            endSel.innerHTML = opts;
            if (stops.length > 0) {
                startSel.value = stops.id;
                endSel.value = stops[stops.length - 1].id;
            }
            renderStops(stops);
            updateDistanceAndPercent(); // recompute distance and coverage for display
        }

        function initSelects() {
            busSel.innerHTML = BUSES.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            // Default select first
            busSel.value = BUSES.id;
            loadStops(busSel.value);
            busSel.addEventListener('change', e => loadStops(e.target.value));
            startSel.addEventListener('change', () => updateDistanceAndPercent());
            endSel.addEventListener('change', () => updateDistanceAndPercent());
        }

        // --- BUS ICON POSITIONING ---
        function positionBusIconByProgress(progress01) {
            // progress01 in[7]
            const timeline = id('timeline');
            const busIcon = id('bus-icon');
            if (!timeline || !busIcon) return;

            // Compute total height spanned by stops
            const stopEls = Array.from(timeline.querySelectorAll('.stop'));
            if (stopEls.length === 0) {
                busIcon.style.transform = 'translateY(0px)';
                return;
            }
            const firstRect = stopEls.getBoundingClientRect();
            const lastRect = stopEls[stopEls.length - 1].getBoundingClientRect();
            const containerRect = timeline.getBoundingClientRect();

            const topY = firstRect.top - containerRect.top;
            const bottomY = lastRect.top - containerRect.top;
            const span = Math.max(0, bottomY - topY);
            const y = topY + span * Math.min(1, Math.max(0, progress01));
            busIcon.style.top = `${y}px`;
        }

        // --- DETAILS AGGREGATIONS ---
        function updateDistanceAndPercent() {
            // Distance shown in distanceVal is overall end-start km difference
            const busId = busSel.value;
            const stops = STOPS[busId] || [];
            const startIdx = stops.findIndex(s => s.id === startSel.value);
            const endIdx = stops.findIndex(s => s.id === endSel.value);
            let totalKm = '--';
            if (startIdx !== -1 && endIdx !== -1) {
                const startKm = stops[startIdx].km;
                const endKm = stops[endIdx].km;
                totalKm = Math.max(0, endKm - startKm);
            }
            const distanceValEl = id('distanceVal');
            if (distanceValEl) distanceValEl.textContent = totalKm === '--' ? '--' : String(totalKm);

            // Simple percent covered example: if backend provides better info, we overwrite it on message
            const percentVal = id('percentVal');
            if (percentVal) percentVal.textContent = totalKm === '--' ? '--' : '0%';
        }

        // --- THEME TOGGLE ---
        themeToggle?.addEventListener('click', () => {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') !== 'light';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            themeToggle.textContent = isDark ? '🌞' : '🌙';
        });

        // --- EMERGENCY MENU ---
        const emBtn = id('emBtn');
        const emMenu = id('emMenu');
        emBtn?.addEventListener('click', () => {
            const isOpen = emMenu.classList.toggle('open');
            emBtn.setAttribute('aria-expanded', String(isOpen));
        });
        document.addEventListener('click', (e) => {
            if (!emBtn.contains(e.target) && !emMenu.contains(e.target)) {
                emMenu.classList.remove('open');
                emBtn.setAttribute('aria-expanded', 'false');
            }
        });

        // --- CHAT ---
        const chatToggle = id('chatToggle');
        const chatBox = id('chatBox');
        const chatClose = id('chatClose');
        chatToggle?.addEventListener('click', () => chatBox.classList.toggle('open'));
        chatClose?.addEventListener('click', () => chatBox.classList.remove('open'));
        const chatForm = id('chatForm');
        const chatBody = id('chatBody');
        chatForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = id('chatMsg');
            const msg = input.value.trim();
            if (!msg) return;
            const b = document.createElement('div');
            b.className = 'bubble me';
            b.textContent = msg;
            chatBody.appendChild(b);
            input.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;
            // Echo bot
            const bot = document.createElement('div');
            bot.className = 'bubble bot';
            bot.textContent = 'Got it. Tracking...';
            chatBody.appendChild(bot);
            chatBody.scrollTop = chatBody.scrollHeight;
        });

        // --- MAP (Leaflet) ---
        let map = null;
        let mapInited = false;
        const showMapBtn = id('showMapBtn');
        const hideMapBtn = id('hideMapBtn');
        const mapContainer = id('mapContainer');

        function initMapIfNeeded() {
            if (mapInited) return;
            map = L.map('map').setView([28.6139, 77.2090], 12); // default view Delhi
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);
            mapInited = true;
        }

        showMapBtn?.addEventListener('click', () => {
            mapContainer.style.display = 'block';
            initMapIfNeeded();
            setTimeout(() => { map.invalidateSize(); }, 50);
        });
        hideMapBtn?.addEventListener('click', () => {
            mapContainer.style.display = 'none';
        });
        // Toggle hide/show buttons visibility
        const toggleMapButtons = () => {
            if (mapContainer.style.display === 'none' || mapContainer.style.display === '') {
                hideMapBtn.style.display = 'none';
                showMapBtn.style.display = 'inline-block';
            } else {
                hideMapBtn.style.display = 'inline-block';
                showMapBtn.style.display = 'none';
            }
        };
        showMapBtn?.addEventListener('click', toggleMapButtons);
        hideMapBtn?.addEventListener('click', toggleMapButtons);

        // --- GEO SPEED (optional, tied to speed display) ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                if (pos.coords && typeof pos.coords.speed === 'number' && !isNaN(pos.coords.speed)) {
                    const kmh = Math.max(0, pos.coords.speed * 3.6);
                    speedVal.textContent = kmh.toFixed(0);
                    speedFabVal.textContent = `${kmh.toFixed(0)} km/h`;
                }
            }, () => { }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
        }

        // --- BACKEND DATA WIRING ---
        // Helper: map time[] entries to timeline and to timeVal..timeVal3
        function applyTimeArrayToETAs(timeArray) {
            // timeVal = Station 1, timeVal1 = Station 2, timeVal2 = Station 3, timeVal3 = Station 4
            const toMinStr = (v) => {
                const n = Math.round(Number(v));
                if (!isFinite(n)) return '--';
                return n + ' min';
            };

            // Set hidden holders first
            if (Array.isArray(timeArray)) {
                if (timeArray.length > 0) id('timeVal').textContent = toMinStr(timeArray);
                if (timeArray.length > 1) id('timeVal1').textContent = toMinStr(timeArray);[7]
                if (timeArray.length > 2) id('timeVal2').textContent = toMinStr(timeArray);[8]
                if (timeArray.length > 3) id('timeVal3').textContent = toMinStr(timeArray);[1]
            }

            // Mirror to timeline stop labels by order
            const stops = currentStops || [];
            stops.forEach((s, idx) => {
                const el = id(`eta-${s.id}`);
                if (!el) return;
                const v = (Array.isArray(timeArray) && timeArray.length > idx) ? toMinStr(timeArray[idx]) : '--';
                el.textContent = `ETA ${v}`;
            });

            // Also set the overall ETA to end (etaVal) to last provided time
            if (Array.isArray(timeArray) && timeArray.length) {
                const last = toMinStr(timeArray[timeArray.length - 1]);
                etaVal.textContent = last;
            }
        }

        // Helper: map distance[] to distanceVal and distanceVal1..3
        function applyDistanceArray(distanceArray) {
            if (!Array.isArray(distanceArray)) return;
            const safeNum = (v) => {
                const n = Number(v);
                return isFinite(n) ? n : '--';
            };
            // Show first in main "Distance (km)"
            if (distanceArray.length > 0) id('distanceVal').textContent = String(safeNum(distanceArray));
            if (distanceArray.length > 1) id('distanceVal1').textContent = String(safeNum(distanceArray));[7]
            if (distanceArray.length > 2) id('distanceVal2').textContent = String(safeNum(distanceArray));[8]
            if (distanceArray.length > 3) id('distanceVal3').textContent = String(safeNum(distanceArray));[1]
        }

        // Helper: move bus icon based on either percent or index
        function updateBusIconFromBackend(data) {
            // Prefer percentage (0..100) if provided, else infer from time progress
            if (typeof data.percent === 'number' && isFinite(data.percent)) {
                positionBusIconByProgress(Math.min(1, Math.max(0, data.percent / 100)));
                const percentVal = id('percentVal');
                if (percentVal) percentVal.textContent = `${Math.round(data.percent)}%`;
                return;
            }
            // Fallback: compute simple progress based on which ETA is shortest
            if (Array.isArray(data.time) && data.time.length && currentStops.length) {
                // Estimate progress as completed stops/total
                let nextIdx = data.time.findIndex(t => Number(t) > 0);
                if (nextIdx === -1) nextIdx = 0;
                const prog = Math.min(1, nextIdx / Math.max(1, currentStops.length - 1));
                positionBusIconByProgress(prog);
            }
        }

        // --- WEBSOCKET AND OTHER LOGIC ---
        const ws = new WebSocket('wss://7f1478a3568e.ngrok-free.app/client');
        ws.addEventListener('open', () => console.log('Connected to Python WebSocket server'));
        ws.addEventListener('message', (event) => {
            let data;
            try {
                data = JSON.parse(event.data);
            } catch {
                console.warn('Non-JSON message', event.data);
                return;
            }

            // Speed
            if (typeof data.speed === 'number' && isFinite(data.speed)) {
                const s = Math.max(0, data.speed);
                speedVal.textContent = String(s);
                speedFabVal.textContent = `${s} km/h`;
            }

            // Percent (also updates bus icon)
            if (typeof data.percent === 'number' && isFinite(data.percent)) {
                const pv = id('percentVal');
                if (pv) pv.textContent = `${Math.round(data.percent)}%`;
            }

            // Distance array mapping (as requested)
            if (data.distance !== undefined && Array.isArray(data.distance)) {
                document.getElementById('distanceVal').textContent = data.distance;
                if (data.distance.length > 1) {
                    document.getElementById('distanceVal1').textContent = data.distance;[7]
                }
                if (data.distance.length > 2) {
                    document.getElementById('distanceVal2').textContent = data.distance;[8]
                }
                if (data.distance.length > 3) {
                    document.getElementById('distanceVal3').textContent = data.distance;[1]
                }
            }

            // Time array mapping (as requested)
            if (data.time !== undefined && Array.isArray(data.time)) {
                const val0 = Math.round(Number(data.time)) + ' min';
                document.getElementById('timeVal').textContent = val0;
                if (data.time.length > 1) {
                    const val1 = Math.round(Number(data.time)) + ' min';[7]
                    document.getElementById('timeVal1').textContent = val1;
                }
                if (data.time.length > 2) {
                    const val2 = Math.round(Number(data.time)) + ' min';[8]
                    document.getElementById('timeVal2').textContent = val2;
                }
                if (data.time.length > 3) {
                    const val3 = Math.round(Number(data.time)) + ' min';[1]
                    document.getElementById('timeVal3').textContent = val3;
                }
            }

            // Mirror the arrays into UI (timeline ETA/overall distance)
            if (Array.isArray(data.distance)) {
                applyDistanceArray(data.distance);
            }
            if (Array.isArray(data.time)) {
                applyTimeArrayToETAs(data.time);
            }

            // Optional: update map with marker if backend sends lat/lng
            if (typeof data.lat === 'number' && typeof data.lng === 'number') {
                initMapIfNeeded();
                map.setView([data.lat, data.lng], map.getZoom() || 13);
                if (!window._busMarker) {
                    window._busMarker = L.marker([data.lat, data.lng]).addTo(map);
                    window._busMarker.bindPopup('Live Bus');
                } else {
                    window._busMarker.setLatLng([data.lat, data.lng]);
                }
            }

            // Update bus icon last to reflect percent/time
            updateBusIconFromBackend(data);
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initSelects();
            toggleMapButtons();
        });
    </script>
</body>

</html>
