<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bus Route - Live</title>
    <meta name="color-scheme" content="dark light" />
    <style>
        :root {
            --bg: #0b0f17;
            --bg-2: #111827;
            --panel: #0f172a;
            --panel-2: #111c31;
            --rail: #22c3a9;
            --rail2: #5aa0ff;
            --accent: #f59e0b;
            --text: #e5e7eb;
            --muted: #a1a1aa;
            --border: #1f2937;
            --node: #e2e8f0;
            --good: #34d399;
        }

        html[data-theme="light"] {
            --bg: #f9fafb;
            --bg-2: #ffffff;
            --panel: #ffffff;
            --panel-2: #f3f4f6;
            --rail: #2563eb;
            --rail2: #22c3a9;
            --accent: #d97706;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #d1d5db;
            --node: #374151;
            --good: #059669;
        }

        * {
            box-sizing: border-box;
        }

        html:focus-within {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            html:focus-within {
                scroll-behavior: auto;
            }
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 50%, #0c1322 100%);
            color: var(--text);
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #0f172acc;
            backdrop-filter: saturate(140%) blur(6px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .brand {
            display: flex;
            align-items: center;
            font-size: 150%;
            gap: 0.8rem;
            font-weight: 800;
            font-family: 'Trebuchet MS';
        }

        .pill {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: conic-gradient(from 180deg, var(--rail), #7dd3fc, var(--rail));
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .field {
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 220px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 10px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
        }

        select {
            flex: 1;
            background: #0b1220;
            color: var(--text);
            border: none;
            outline: none;
            font: inherit;
            border-radius: 10px;
        }

        select:focus-visible {
            outline: 2px solid var(--rail);
            outline-offset: 2px;
            border-radius: 8px;
        }

        select::-webkit-listbox {
            background: #0b1220;
            color: var(--text);
            border: 1px solid var(--border);
        }

        select::-webkit-selection,
        select option:checked {
            background: #182338;
            color: #ffffff;
        }

        select option {
            background: #0b1220;
            color: var(--text);
        }

        select option:hover,
        select option:checked {
            background: #182338;
            color: #ffffff;
        }

        html[data-theme="light"] select {
            background: #fff;
            color: var(--text);
        }

        html[data-theme="light"] select::-webkit-listbox,
        html[data-theme="light"] select option {
            background: #fff;
            color: var(--text);
            border-color: var(--border);
        }

        html[data-theme="light"] select option:hover,
        html[data-theme="light"] select option:checked,
        html[data-theme="light"] select::-webkit-selection {
            background: #f3f4f6;
            color: var(--text);
        }

        .lang {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px 10px;
        }

        .lang select {
            min-width: 140px;
        }

        main {
            max-width: 1180px;
            margin: 16px auto;
            padding: 0 16px;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 18px;
        }

        @media (max-width: 980px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
        }

        .panel h2,
        .panel h3 {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .8px;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            min-height: 80px;
            padding-left: 28px;
        }

        .axis {
            position: absolute;
            left: 14px;
            width: 4px;
            border-radius: 4px;
            background: linear-gradient(180deg, var(--rail), #7dd3fc);
            z-index: 1;
            /* top and height will be set by js */
        }

        .stop {
            position: relative;
            margin: 18px 0;
            padding: 14px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            border-radius: 14px;
            transition: transform .15s ease, background .2s;
            z-index: 2;
        }

        .stop:hover {
            background: rgba(255, 255, 255, .06);
            transform: translateY(-1px);
        }

        html[data-theme="light"] .stop {
            background: #fff;
            border-color: var(--border);
        }

        html[data-theme="light"] .stop:hover {
            background: #f3f4f6;
        }

        .dot {
            position: absolute;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--node);
            border: 3px solid var(--rail);
            box-shadow: 0 0 0 3px rgba(34, 195, 169, .25);
            z-index: 2;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .name {
            font-weight: 800;
        }

        .meta {
            font-size: 12px;
            color: var(--muted);
        }

        .eta {
            color: var(--accent);
            font-weight: 800;
        }

        .in-range {
            background: rgba(34, 195, 169, .10);
            border-color: #0ee9be;
        }

        html[data-theme="light"] .in-range {
            background: #e0f2fe;
            border-color: #bae6fd;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(34, 195, 169, .12);
            border: 1px solid rgba(34, 195, 169, .55);
            color: var(--rail);
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: .3px;
        }

        .spin {
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            grid-template-rows: repeat(2, minmax(0, 1fr));
            gap: 12px;

        }

        .stat {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
        }

        html[data-theme="light"] .stat {
            background: #fafafa;
            border-color: var(--border);
        }

        .label {
            font-size: 12px;
            color: var(--muted);
        }

        .value {
            font-weight: 900;
            font-size: 20px;
            margin-top: 2px;
        }

        .fab {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 18;
            background: linear-gradient(135deg, var(--rail), #86e3d3);
            color: #0a1b1a;
            border: none;
            border-radius: 999px;
            padding: 14px 18px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, .35);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fab small {
            display: block;
            font-size: 10px;
            opacity: .85;
            letter-spacing: .3px;
        }

        .fab .big {
            font-size: 22px;
            font-weight: 900;
        }

        .em-trigger {
            position: fixed;
            right: 16px;
            bottom: 96px;
            z-index: 18;
            background: #f00606;
            border: 1px solid var(--border);
            color: #efefef;
            font-weight: 800;
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .3);
            font-size: 80%;
        }


        .em-menu {
            position: fixed;
            right: 16px;
            bottom: 146px;
            z-index: 18;
            display: none;
            min-width: 230px;
            background: #101828;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .3);
        }

        .em-menu.open {
            display: block;
        }

        .em-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #1f2a3e;
        }

        .em-item:last-child {
            border-bottom: none;
        }

        .em-item small {
            color: var(--muted);
        }

        .em-item a {
            background: radial-gradient(circle at 30% 30%, #ffd1d1, #ff6b6b);
            color: #2b0b0b;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 800;
        }

        .chat-fab {
            position: fixed;
            left: 16px;
            bottom: 16px;
            z-index: 18;
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: none;
            background: conic-gradient(from 180deg at 50% 50%, #86efac, #22c3a9, #5aa0ff, #86efac);
            color: #0a1632;
            display: grid;
            place-items: center;
            box-shadow: 0 12px 36px rgba(0, 0, 0, .35);
            cursor: pointer;
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
        }

        .chat {
            position: fixed;
            left: 16px;
            bottom: 86px;
            z-index: 18;
            width: 320px;
            max-height: 60vh;
            display: none;
            flex-direction: column;
            background: #101828;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }

        .chat.open {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
            padding: 10px 12px;
            background: #0f172a;
            border-bottom: 1px solid var(--border);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
        }

        .chat-logo {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff, #9be7ff);
        }

        .chat-body {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
        }

        .bubble {
            max-width: 80%;
            padding: 8px 10px;
            border-radius: 12px;
        }

        .bot {
            background: #14223d;
            color: #e2ebff;
            align-self: flex-start;
        }

        .me {
            background: #1b2a4d;
            color: #e2ebff;
            align-self: flex-end;
        }

        .chat-input {
            display: flex;
            gap: 6px;
            padding: 10px;
            border-top: 1px solid var(--border);
            background: #101828;
        }

        .chat-input input {
            flex: 1;
            background: #0b1220;
            border: 1px solid #1f2a3e;
            border-radius: 10px;
            color: var(--text);
            padding: 8px;
        }

        .chat-input button {
            background: linear-gradient(135deg, var(--rail), #7de6d5);
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            color: #0a1b1a;
            font-weight: 800;
        }

        #themeToggle {
            background: var(--panel-2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <header>
        <div class="brand"><span class="pill" aria-hidden="true"></span> <span id="title">Bus Route Live</span></div>
        <div class="toolbar" role="group" aria-label="Selections">
            <div class="field"><label for="busSel" id="lblBus">Bus</label><select id="busSel" name="bus"></select></div>
            <div class="field"><label for="startSel" id="lblStart">Start</label><select id="startSel"
                    name="start"></select></div>
            <div class="field"><label for="endSel" id="lblEnd">End</label><select id="endSel" name="end"></select></div>
            <div class="lang" aria-label="Language picker">
                <label for="langSel" id="lblLang">Language</label>
                <select id="langSel">
                    <option value="en" lang="en" selected>English</option>
                    <option value="hi" lang="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                    <option value="pa" lang="pa">à¨ªà©°à¨œà¨¾à¨¬à©€</option>
                </select>
            </div>
            <button id="themeToggle">ðŸŒ™</button>
            <span class="chip" id="liveBadge"><span class="spin" aria-hidden="true"></span> LIVE</span>
        </div>

    </header>
    <main>
        <section class="panel" aria-labelledby="routeTitle">
            <h2 id="routeTitle">Route timeline</h2>
            <div class="timeline" id="timeline" role="list">
                <div class="axis" aria-hidden="true"></div>
            </div>
        </section>
        <aside class="panel" aria-labelledby="detailsTitle">
            <h2 id="detailsTitle">Details</h2>
            <div class="grid">


                <div class="stat">
                    <div class="label" id="lblSpeed">Current speed</div>
                    <div class="value"><span id="speedVal">--</span> km/h</div>
                </div>
                <div class="stat">
                    <div class="label" id="lblEta">ETA to end</div>
                    <div class="value" id="etaVal">--</div>
                </div>
                <!-- Add these new stats -->
                <div class="stat">
                    <div class="label">Distance (km)</div>
                    <div class="value" id="distanceVal">--</div>
                </div>
                <div class="stat">
                    <div class="label">Time (h)</div>
                    <div class="value" id="timeVal">--</div>
                </div>
                <div class="stat">
                    <div class="label">Route Covered (%)</div>
                    <div class="value" id="percentVal">--</div>
                </div>
                <div class="stat">
                    <div class="label">Stops</div>
                    <div class="value" id="stopCountVal">--</div>
                </div>
            </div>


            </div>
            <p class="label" style="margin-top:10px" id="geoHint">Pick a bus, then choose Start and End stops; allow
                location for live speed.</p>
        </aside>
    </main>
    <button class="em-trigger" id="emBtn" aria-haspopup="true" aria-expanded="false">âš  Emergency</button>
    <div class="em-menu" id="emMenu" role="menu" aria-label="Emergency contacts">
        <div class="em-item" role="menuitem">
            <div><strong id="polLbl">Police</strong> <small>100</small></div><a href="tel:100" id="polAct">Call</a>
        </div>
        <div class="em-item" role="menuitem">
            <div><strong id="hosLbl">Hospital</strong> <small>108</small></div><a href="tel:108" id="hosAct">Call</a>
        </div>
        <div class="em-item" role="menuitem">
            <div><strong id="busLbl">Bus Service</strong> <small>1800-000-111</small></div><a href="tel:1800000111"
                id="busAct">Call</a>
        </div>
    </div>
    <button class="fab" id="speedFab" aria-live="polite">
        <div><small id="speedSmall">Speed</small>
            <div class="big" id="speedFabVal">-- km/h</div>
        </div>
    </button>
    <button class="chat-fab" id="chatToggle" aria-label="Open chatbot"><svg viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M21 15a4 4 0 0 1-4 4H9l-6 4 2-6a8 8 0 1 1 16-2Z" />
            <circle cx="9" cy="13" r="1" />
            <circle cx="13" cy="13" r="1" />
            <circle cx="17" cy="13" r="1" />
        </svg></button>
    <section class="chat" id="chatBox" aria-label="Chatbot" aria-live="polite">
        <div class="chat-header">
            <div class="chat-title"><span class="chat-logo" aria-hidden="true"></span><span
                    id="chatTitle">Chatbot</span></div><button
                style="background:#1b263b;border:none;color:#dbe7ff;border-radius:8px;padding:4px 8px"
                id="chatClose">Ã—</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="bubble bot" id="chatWelcome">Hi! Ask about routes, stops, or ETAs.</div>
        </div>
        <form class="chat-input" id="chatForm"><input type="text" id="chatMsg" placeholder="Type message..."
                autocomplete="off" /><button type="submit" id="sendBtn">Send</button></form>
    </section>
    <script>
        const BUSES = [{ id: 'B1', name: 'Bus 1' }, { id: 'B2', name: 'Bus 2' }, { id: 'B3', name: 'Bus 3' }];
        const STOPS = {
            B1: [{ id: 'S1', name: 'Station 1', km: 0 }, { id: 'S2', name: 'Station 2', km: 4 }, { id: 'S3', name: 'Station 3', km: 8 }, { id: 'S4', name: 'Station 4', km: 12 }],
            B2: [{ id: 'S5', name: 'Station 5', km: 0 }, { id: 'S6', name: 'Station 6', km: 7 }, { id: 'S7', name: 'Station 7', km: 22 }],
            B3: [{ id: 'S8', name: 'Station 8', km: 0 }, { id: 'S9', name: 'Station 9', km: 3 }, { id: 'S10', name: 'Station 10', km: 5 }]
        };
        const $ = id => document.getElementById(id);
        const busSel = $('busSel'), startSel = $('startSel'), endSel = $('endSel'), timeline = $('timeline');
        const speedVal = $('speedVal'), speedFabVal = $('speedFabVal'), etaVal = $('etaVal');
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            themeToggle.textContent = next === 'light' ? 'â˜€ï¸' : 'ðŸŒ™';
        });
        const STR = {
            en: { title: 'Bus Route Live', bus: 'Bus', start: 'Start', end: 'End', route: 'Route timeline', details: 'Details', speed: 'Current speed', eta: 'ETA to end', speedSmall: 'Speed', hint: 'Pick a bus, then choose Start and End stops; allow location for live speed.' },
            hi: { title: 'à¤¬à¤¸ à¤°à¥‚à¤Ÿ à¤²à¤¾à¤‡à¤µ', bus: 'à¤¬à¤¸', start: 'à¤¶à¥à¤°à¥à¤†à¤¤', end: 'à¤…à¤‚à¤¤', route: 'à¤°à¥‚à¤Ÿ à¤Ÿà¤¾à¤‡à¤®à¤²à¤¾à¤‡à¤¨', details: 'à¤µà¤¿à¤µà¤°à¤£', speed: 'à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤—à¤¤à¤¿', eta: 'à¤…à¤‚à¤¤ à¤¤à¤• ETA', speedSmall: 'à¤—à¤¤à¤¿', hint: 'à¤¬à¤¸ à¤šà¥à¤¨à¥‡à¤‚ à¤”à¤° à¤¸à¥à¤Ÿà¤¾à¤°à¥à¤Ÿ/à¤à¤‚à¤¡ à¤¸à¥à¤Ÿà¥‰à¤ª à¤šà¥à¤¨à¥‡à¤‚; à¤²à¤¾à¤‡à¤µ à¤—à¤¤à¤¿ à¤•à¥‡ à¤²à¤¿à¤ à¤²à¥‹à¤•à¥‡à¤¶à¤¨ à¤…à¤¨à¥à¤®à¤¤à¤¿ à¤¦à¥‡à¤‚à¥¤' },
            pa: { title: 'à¨¬à¨¸ à¨°à©‚à¨Ÿ à¨²à¨¾à¨ˆà¨µ', bus: 'à¨¬à¨¸', start: 'à¨¸à¨¼à©à¨°à©‚', end: 'à¨…à©°à¨¤', route: 'à¨°à©‚à¨Ÿ à¨Ÿà¨¾à¨ˆà¨®à¨²à¨¾à¨ˆà¨¨', details: 'à¨µà©‡à¨°à¨µà©‡', speed: 'à¨®à©Œà¨œà©‚à¨¦à¨¾ à¨—à¨¤à©€', eta: 'à¨…à©°à¨¤ à¨¤à©±à¨• ETA', speedSmall: 'à¨¸à¨ªà©€à¨¡', hint: 'à¨¬à¨¸ à¨šà©à¨£à©‹ à¨…à¨¤à©‡ à¨¸à¨¼à©à¨°à©‚/à¨…à©°à¨¤ à¨¸à¨Ÿà¨¾à¨ª à¨šà©à¨£à©‹; à¨²à¨¾à¨ˆà¨µ à¨¸à¨ªà©€à¨¡ à¨²à¨ˆ à¨²à©‹à¨•à©‡à¨¶à¨¨ à¨‡à¨œà¨¾à¨œà¨¼à¨¤ à¨¦à¨¿à¨“à¥¤' }
        };
        let LANG = 'en';
        function applyLang() {
            const T = STR[LANG];
            document.documentElement.lang = LANG;
            $('title').textContent = T.title;
            $('lblBus').textContent = T.bus;
            $('lblStart').textContent = T.start;
            $('lblEnd').textContent = T.end;
            $('routeTitle').textContent = T.route;
            $('detailsTitle').textContent = T.details;
            $('lblSpeed').textContent = T.speed;
            $('lblEta').textContent = T.eta;
            $('speedSmall').textContent = T.speedSmall;
            $('geoHint').textContent = T.hint;
        }
        $('langSel').addEventListener('change', e => {
            LANG = e.target.value;
            applyLang();
        });
        function initSelects() {
            busSel.innerHTML = BUSES.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            loadStops(busSel.value);
        }
        function loadStops(busId) {
            const stops = STOPS[busId] || [];
            const opts = stops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            startSel.innerHTML = opts;
            endSel.innerHTML = opts;
            if (stops.length) {
                startSel.value = stops[0].id;
                endSel.value = stops[stops.length - 1].id;
            }
            renderStops(stops);
            updateRangeHighlight();
            updateETA();
        }
        busSel.addEventListener('change', e => loadStops(e.target.value));
        [startSel, endSel].forEach(sel => sel.addEventListener('change', () => {
            updateRangeHighlight();
            updateETA();
        }));
        let currentStops = [];
        function renderStops(stops) {
            currentStops = stops;
            timeline.querySelectorAll('.stop').forEach(n => n.remove());
            stops.forEach(s => {
                const el = document.createElement('div');
                el.className = 'stop';
                el.dataset.id = s.id;
                el.setAttribute('role', 'listitem');
                el.innerHTML = `<span class="dot" aria-hidden="true"></span><div class="row"><div><div class="name">${s.name}</div><div class="meta">${s.km} km from start</div></div><div class="eta" id="eta-${s.id}">ETA --</div></div>`;
                timeline.appendChild(el);
            });
            const stopsEls = timeline.querySelectorAll('.stop');
            const axis = timeline.querySelector('.axis');
            if (stopsEls.length && axis) {
                const first = stopsEls[0], last = stopsEls[stopsEls.length - 1];
                const axisTop = first.offsetTop + first.offsetHeight / 2;
                const axisBottom = last.offsetTop + last.offsetHeight / 2;
                axis.style.top = axisTop + "px";
                axis.style.height = (axisBottom - axisTop) + "px";
            }
        }
        function updateRangeHighlight() {
            const startId = startSel.value, endId = endSel.value;
            const ids = currentStops.map(s => s.id);
            const i0 = ids.indexOf(startId), i1 = ids.indexOf(endId);
            const [a, b] = i0 <= i1 ? [i0, i1] : [i1, i0];
            timeline.querySelectorAll('.stop').forEach((el, idx) => el.classList.toggle('in-range', idx >= a && idx <= b));
        }
        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        function calcDistanceKm(aId, bId) {
            const idx = currentStops.findIndex(s => s.id === aId);
            const jdx = currentStops.findIndex(s => s.id === bId);
            if (idx < 0 || jdx < 0) return 0;
            const [a, b] = idx <= jdx ? [idx, jdx] : [jdx, idx];
            const kmA = currentStops[a].km, kmB = currentStops[b].km;
            return Math.max(0, kmB - kmA);
        }
        function updateETA() {
            const startId = startSel.value, endId = endSel.value;
            const dist = calcDistanceKm(startId, endId);
            const v = Number.isFinite(Number(speedVal.textContent)) ? clamp(Number(speedVal.textContent), 8, 90) : 25;
            const minutes = Math.max(1, Math.round((dist / v) * 60));
            etaVal.textContent = `${minutes} min`;
            const endLabel = document.getElementById(`eta-${endId}`);
            if (endLabel) endLabel.textContent = `ETA ${minutes} min`;
        }
        const kmh = mps => (mps * 3.6).toFixed(0);
        let prev = null;
        function toRad(x) { return x * Math.PI / 180; }
        function hav(a, b) {
            const R = 6371000;
            const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lon - a.lon), A = toRad(a.lat), B = toRad(b.lat);
            const h = Math.sin(dLat / 2) ** 2 + Math.cos(A) * Math.cos(B) * Math.sin(dLon / 2) ** 2;
            return 2 * R * Math.asin(Math.sqrt(h));
        }
        function onGeo(pos) {
            const c = pos.coords;
            let v = c.speed != null ? kmh(c.speed) : null;
            if (v == null && prev) {
                const dt = (pos.timestamp - prev.t) / 1000;
                const d = hav(prev, { lat: c.latitude, lon: c.longitude });
                v = (d / dt * 3.6).toFixed(0);
            }
            if (!Number.isFinite(Number(v))) v = '--';
            speedVal.textContent = v;
            speedFabVal.textContent = `${v} km/h`;
            prev = { lat: c.latitude, lon: c.longitude, t: pos.timestamp };
            updateETA();
        }
        function onGeoError(err) { $('geoHint').textContent = `${STR[LANG].hint} (${err.message})`; }
        function startDemoIfIdle() { setTimeout(() => { if (String(speedVal.textContent).trim() !== '--') return; let t = 0, lat = 23.025, lon = 72.571; setInterval(() => { t += 1.5; lat += 0.0008; lon += 0.0005 * Math.sin(t / 5); onGeo({ coords: { latitude: lat, longitude: lon, accuracy: 15, heading: 90, speed: null }, timestamp: Date.now() }); speedVal.textContent = '40'; speedFabVal.textContent = '40 km/h'; }, 1500); }, 3000); }
        const chatToggle = $('chatToggle'), chatBox = $('chatBox'), chatClose = $('chatClose'), chatForm = $('chatForm'), chatBody = $('chatBody'), chatMsg = $('chatMsg');
        chatToggle.onclick = () => chatBox.classList.toggle('open');
        chatClose.onclick = () => chatBox.classList.remove('open');
        chatForm.addEventListener('submit', e => {
            e.preventDefault();
            const text = chatMsg.value.trim(); if (!text) return;
            chatBody.insertAdjacentHTML('beforeend', `<div class="bubble me">${text}</div>`);
            chatMsg.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;
            setTimeout(() => {
                chatBody.insertAdjacentHTML('beforeend', `<div class="bubble bot">Thanks! This is a demo reply.</div>`);
                chatBody.scrollTop = chatBody.scrollHeight;
            }, 600);
        });
        const emBtn = $('emBtn'), emMenu = $('emMenu');
        function closeMenu() { emMenu.classList.remove('open'); emBtn.setAttribute('aria-expanded', 'false'); }
        function toggleMenu() { const open = !emMenu.classList.contains('open'); if (open) { emMenu.classList.add('open'); emBtn.setAttribute('aria-expanded', 'true'); } else { closeMenu(); } }
        emBtn.addEventListener('click', e => { e.stopPropagation(); toggleMenu(); });
        document.addEventListener('click', e => { if (!emMenu.contains(e.target) && e.target !== emBtn) closeMenu(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMenu(); });
        applyLang();
        initSelects();
        startGeo();
        startDemoIfIdle();
           
        const ws = new WebSocket('wss://7c2e194a8b2d.ngrok-free.app/client');

        ws.addEventListener("open", () => {
            console.log("Connected to Python WebSocket server");
        });

        ws.addEventListener("message", (event) => {
            try {
                const data = JSON.parse(event.data);

                // Update speed display
                if (data.speed !== undefined && data.speed !== null) {
                    const speed = Number(data.speed);
                    speedVal.textContent = isFinite(speed) ? speed.toFixed(0) : '--';
                    speedFabVal.textContent = isFinite(speed) ? `${speed.toFixed(0)} km/h` : '-- km/h';
                }

                // Update ETA display if available
                if (data.eta !== undefined && data.eta !== null) {
                    etaVal.textContent = `${data.eta} min`;
                }


            } catch (err) {
                console.error("Error parsing WebSocket message:", err);
            }
        });

        ws.addEventListener("close", () => {
            console.log("Disconnected from Python WebSocket server");
        });

        ws.addEventListener("error", (err) => {
            console.error("WebSocket error:", err);
        });
    </script>
</body>

</html>
